#!/bin/bash

# # –≠—Ç–æ—Ç Bash-—Å–∫—Ä–∏–ø—Ç –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ –ª–æ–≥–æ–≤ Xray –Ω–æ–¥—ã Remnawave –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ Docker. 
# 
# # üîπ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
# # ‚úÖ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥–∫–ª—é—á–∞–ª–∏—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 1000 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞).
# # ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ ‚Äì –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–ª–µ–¥–∏—Ç—å –∑–∞ –µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é (tail -f).
# # ‚úÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π ‚Äì –≤—ã–≤–æ–¥ –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
# # ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö ‚Äì –º–æ–∂–Ω–æ –±—ã—Å—Ç—Ä–æ –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

# –¶–≤–µ—Ç–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
CONTAINER_NAME="remnanode"
LOG_PATH="/var/log/supervisor/xray.out.log"
LOG_LINES=1000 # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º—ã—Ö —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–≥–æ–≤
get_recent_logs() {
    docker exec "$CONTAINER_NAME" tail -n $LOG_LINES "$LOG_PATH" 2>/dev/null
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
get_users() {
    get_recent_logs | grep -o "email: [^ ]*" | awk '{print $2}' | sort -u
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
tail_user_logs() {
    local user="$1"
    echo -e "${YELLOW}–°–ª–µ–¥–∏–º –∑–∞ –ª–æ–≥–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $user (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)...${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    docker exec -it "$CONTAINER_NAME" tail -n 10 -f "$LOG_PATH" | \
    grep --line-buffered "accepted.*email: $user"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
tail_all_logs() {
    echo -e "${YELLOW}–°–ª–µ–¥–∏–º –∑–∞ –≤—Å–µ–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)...${NC}"
    echo -e "${BLUE}------------------------------------------------------------${NC}"
    docker exec -it "$CONTAINER_NAME" tail -n 10 -f "$LOG_PATH" | \
    grep --line-buffered "accepted"
}

# –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
while true; do
    clear
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    all_users=($(get_users))
    
    echo -e "${GREEN}===============================================${NC}"
    echo -e "${CYAN}      –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ª–æ–≥–æ–≤ Xray ($CONTAINER_NAME)${NC}"
    echo -e "${GREEN}===============================================${NC}"
    echo -e "${YELLOW}1) –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ–≥–æ: ${#all_users[@]})${NC}"
    echo -e "${YELLOW}2) –°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏${NC}"
    echo -e "${YELLOW}3) –°–º–æ—Ç—Ä–µ—Ç—å –í–°–ï –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏${NC}"
    echo -e "${YELLOW}4) –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ${NC}"
    echo -e "${RED}0) –í—ã—Ö–æ–¥${NC}"
    echo -e "${GREEN}-----------------------------------------------${NC}"
    
    read -p "$(echo -e ${CYAN}'–í–∞—à –≤—ã–±–æ—Ä: '${NC})" choice
    
    case $choice in
        1)
            clear
            echo -e "${CYAN}–°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:${NC}"
            echo -e "${BLUE}--------------------------${NC}"
            for i in "${!all_users[@]}"; do
                echo -e "${YELLOW}$((i+1))) ${all_users[i]}${NC}"
            done
            echo -e "${BLUE}--------------------------${NC}"
            read -p "$(echo -e ${CYAN}'–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...'${NC})" 
            ;;
        2)
            clear
            if [ ${#all_users[@]} -eq 0 ]; then
                echo -e "${RED}–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ª–æ–≥–∞—Ö.${NC}"
                read -p "$(echo -e ${CYAN}'–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...'${NC})"
                continue
            fi
            
            echo -e "${CYAN}–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:${NC}"
            for i in "${!all_users[@]}"; do
                echo -e "${YELLOW}$((i+1))) ${all_users[i]}${NC}"
            done
            
            read -p "$(echo -e ${CYAN}'–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: '${NC})" user_num
            if [[ ! "$user_num" =~ ^[0-9]+$ ]] || [ "$user_num" -lt 1 ] || [ "$user_num" -gt ${#all_users[@]} ]; then
                echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä.${NC}"
                read -p "$(echo -e ${CYAN}'–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é...'${NC})"
                continue
            fi
            
            user="${all_users[$((user_num-1))]}"
            clear
            tail_user_logs "$user"
            ;;
        3)
            clear
            tail_all_logs
            ;;
        4)
            # –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º —ç–∫—Ä–∞–Ω
            ;;
        0)
            echo -e "${RED}–í—ã—Ö–æ–¥...${NC}"
            exit 0
            ;;
        *)
            echo -e "${RED}–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
            sleep 1
            ;;
    esac
done
