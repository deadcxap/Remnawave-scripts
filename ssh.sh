#!/bin/bash

# === –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê SSH ===
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSH-—Å–µ—Ä–≤–µ—Ä–∞:
# 1. –î–æ–±–∞–≤–ª—è–µ—Ç –ø—É–±–ª–∏—á–Ω—ã–π SSH-–∫–ª—é—á –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ authorized_keys (–∏–∑–±–µ–≥–∞—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤).
# 2. –ò–∑–º–µ–Ω—è–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ä—Ç SSH.
# 3. –û—Ç–∫–ª—é—á–∞–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ –ø–∞—Ä–æ–ª—é.
# 4. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ñ–∞–µ—Ä–≤–æ–ª UFW.
# 5. –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –Ω–µ –ª–æ–º–∞—é—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é).

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${CYAN}=== –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê SSH ===${NC}"

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—Ç –∏–º–µ–Ω–∏ root ---
if [[ $EUID -ne 0 ]]; then
  echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è root –∏–ª–∏ —á–µ—Ä–µ–∑ sudo.${NC}"
  exit 1
else
  echo -e "${GREEN}‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤: –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å root-–¥–æ—Å—Ç—É–ø–æ–º.${NC}"
fi

# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Ü–µ–ª–µ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
TARGET_USER_HOME="$HOME"
TARGET_USER=$(basename "$TARGET_USER_HOME")

if [[ "$TARGET_USER_HOME" == "/root" ]]; then
    echo -e "${CYAN}‚ÑπÔ∏è –ö–ª—é—á –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 'root' ($TARGET_USER_HOME/.ssh).${NC}"
else
    echo -e "${YELLOW}‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –ö–ª—é—á –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$TARGET_USER' ($TARGET_USER_HOME/.ssh). –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –Ω—É–∂–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.${NC}"
    if ! id "$TARGET_USER" &>/dev/null; then
        echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å '$TARGET_USER' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ TARGET_USER_HOME.${NC}"
        exit 1
    fi
fi
echo ""

# --- –†–∞–∑–±–æ—Ä –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ ---
DEFAULT_SSH_PORT=2222
SSH_PORT="$DEFAULT_SSH_PORT"
SSH_KEY=""

show_usage() {
  echo -e "${CYAN}–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [-p –ø–æ—Ä—Ç (1-65535)] [-k '\"public_ssh_key\"']${NC}"
  exit 1
}

while getopts ":p:k:" opt; do
  case $opt in
    p)
      SSH_PORT="$OPTARG"
      ;;
    k)
      SSH_KEY="$OPTARG"
      ;;
    \?)
      echo -e "${RED}‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä -$OPTARG${NC}"
      show_usage
      ;;
    :)  
      echo -e "${RED}‚ùå –û–ø—Ü–∏—è -$OPTARG —Ç—Ä–µ–±—É–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–∞.${NC}"
      show_usage
      ;;
  esac
done
shift $((OPTIND -1))

# --- –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ—Ä—Ç–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä) ---
if ! [[ "$SSH_PORT" =~ ^[0-9]+$ ]] || [[ "$SSH_PORT" -lt 1 ]] || [[ "$SSH_PORT" -gt 65535 ]]; then
  echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ—Ä—Ç–∞. –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 65535.${NC}"
  exit 1
else
  echo -e "${GREEN}‚úÖ –ü–æ—Ä—Ç SSH —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: ${SSH_PORT}.${NC}"
fi

echo ""
# --- –ß—Ç–µ–Ω–∏–µ SSH-–∫–ª—é—á–∞ (–µ—Å–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω —á–µ—Ä–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä) ---
if [[ -z "$SSH_KEY" ]]; then
  echo -e "${CYAN}‚û°Ô∏è –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –ü–£–ë–õ–ò–ß–ù–´–ô SSH-–∫–ª—é—á (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ .pub, –Ω–∞–ø—Ä–∏–º–µ—Ä, id_rsa.pub):${NC}"
  while [[ -z "$SSH_KEY" ]]; do
    read -rp ">>> " SSH_KEY
    if [[ -z "$SSH_KEY" ]]; then
      echo -e "${YELLOW} –ü–æ–ª–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ –∫–ª—é—á.${NC}"
    elif ! [[ "$SSH_KEY" =~ ^ssh-(rsa|ed25519|ecdsa|dss) ]]; then
       echo -e "${RED}‚ùå –í–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø–æ—Ö–æ–∂–∞ –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–π SSH-–∫–ª—é—á (–¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å ssh-rsa, ssh-ed25519 –∏ —Ç.–ø.). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.${NC}"
       SSH_KEY=""
    fi
  done
  echo -e "${GREEN}‚úÖ –ö–ª—é—á –ø—Ä–∏–Ω—è—Ç.${NC}"
else
  echo -e "${GREEN}‚úÖ –ö–ª—é—á –ø—Ä–∏–Ω—è—Ç –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.${NC}"
fi

echo ""
# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ UFW ---
SETUP_UFW=""
echo -e "${CYAN}‚û°Ô∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ñ–∞–µ—Ä–≤–æ–ª UFW –¥–ª—è –Ω–æ–≤–æ–≥–æ SSH-–ø–æ—Ä—Ç–∞ (${SSH_PORT})?${NC}"
echo "   1) –î–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –µ—Å–ª–∏ UFW –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–ª–∏ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è)"
echo "   2) –ù–µ—Ç"
while [[ "$SETUP_UFW" != "1" && "$SETUP_UFW" != "2" ]]; do
    read -rp ">>> –í–∞—à –≤—ã–±–æ—Ä [1/2]: " SETUP_UFW
    if [[ "$SETUP_UFW" != "1" && "$SETUP_UFW" != "2" ]]; then
        echo -e "${RED}‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä. –í–≤–µ–¥–∏—Ç–µ 1 –∏–ª–∏ 2.${NC}"
    fi
done
if [[ "$SETUP_UFW" == "1" ]]; then
    echo -e "${GREEN}‚úÖ UFW –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω.${NC}"
else
    echo -e "${YELLOW}‚ÑπÔ∏è UFW –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è –Ω–µ –±—É–¥–µ—Ç. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç ${SSH_PORT} —Ä–∞–∑—Ä–µ—à–µ–Ω –≤ –≤–∞—à–µ–º —Ñ–∞–µ—Ä–≤–æ–ª–µ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω.${NC}"
fi

echo ""
# === –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ .ssh –∏ —Ñ–∞–π–ª–∞ authorized_keys ===
echo -e "${CYAN}--- –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH-–∫–ª—é—á–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è '$TARGET_USER' ---${NC}"
SSH_DIR="$TARGET_USER_HOME/.ssh"
AUTHORIZED_KEYS="$SSH_DIR/authorized_keys"

echo -e "üîß –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ $SSH_DIR (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)..."
mkdir -p "$SSH_DIR"
if [[ $? -ne 0 ]]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ $SSH_DIR.${NC}"
    exit 1
fi

echo -e "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è $SSH_DIR (700)..."
chmod 700 "$SSH_DIR"

echo -e "üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ $AUTHORIZED_KEYS (–µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)..."
touch "$AUTHORIZED_KEYS"
if [[ $? -ne 0 ]]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª $AUTHORIZED_KEYS.${NC}"
    exit 1
fi

echo -e "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è $AUTHORIZED_KEYS (600)..."
chmod 600 "$AUTHORIZED_KEYS"

echo -e "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–ª—é—á–∞ –≤ $AUTHORIZED_KEYS..."
if grep -q -F -x "$SSH_KEY" "$AUTHORIZED_KEYS"; then
  echo -e "${YELLOW}‚ÑπÔ∏è –≠—Ç–æ—Ç SSH-–∫–ª—é—á —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ñ–∞–π–ª–µ $AUTHORIZED_KEYS. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–æ.${NC}"
else
  echo -e "üîß –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ –≤ $AUTHORIZED_KEYS..."
  if [[ -s "$AUTHORIZED_KEYS" ]] && [[ "$(tail -c 1 "$AUTHORIZED_KEYS")" != "" ]]; then
      echo "" >> "$AUTHORIZED_KEYS"
  fi
  echo "$SSH_KEY" >> "$AUTHORIZED_KEYS"
  echo -e "${GREEN}‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ $AUTHORIZED_KEYS.${NC}"
fi

echo -e "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ $SSH_DIR –∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –Ω–∞ '$TARGET_USER'..."
chown -R "${TARGET_USER}:${TARGET_USER}" "$SSH_DIR" 2>/dev/null || echo -e "${YELLOW}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ $SSH_DIR. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ root.${NC}"
chmod 700 "$SSH_DIR"
chmod 600 "$AUTHORIZED_KEYS"
echo ""

# === –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH (/etc/ssh/sshd_config) ===
echo -e "${CYAN}--- –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SSH-—Å–µ—Ä–≤–µ—Ä–∞ ---${NC}"
SSHD_CONFIG="/etc/ssh/sshd_config"
SSHD_CONFIG_BACKUP="${SSHD_CONFIG}.bak_$(date +%Y%m%d_%H%M%S)"

echo -e "üîß –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ $SSHD_CONFIG –≤ ${SSHD_CONFIG_BACKUP}..."
cp "$SSHD_CONFIG" "$SSHD_CONFIG_BACKUP"
if [[ $? -ne 0 ]]; then
    echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ SSH.${NC}"
    echo -e "${YELLOW}‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –±–µ–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏.${NC}"
else
    echo -e "${GREEN}‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${SSHD_CONFIG_BACKUP}${NC}"
fi

update_sshd_config() {
  local PARAM="$1"
  local VALUE="$2"
  local CONFIG_FILE="$3"
  local CURRENT_VALUE
  local LINE_EXISTS=false
  local IS_COMMENTED=false

  if grep -qE "^\s*#?\s*${PARAM}\s+" "$CONFIG_FILE"; then
      LINE_EXISTS=true
      if grep -qE "^\s*#\s*${PARAM}\s+" "$CONFIG_FILE"; then
          IS_COMMENTED=true
      fi
      CURRENT_VALUE=$(grep -E "^\s*${PARAM}\s+" "$CONFIG_FILE" | awk '{print $2}' | head -n 1)
  fi

  if [[ "$LINE_EXISTS" == true && "$IS_COMMENTED" == false && "$CURRENT_VALUE" == "$VALUE" ]]; then
      echo -e "${CYAN}‚ÑπÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä '${PARAM}' —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ '${VALUE}'. –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è.${NC}"
  else
      echo -e "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ '${PARAM}' –≤ '${VALUE}'..."
      if [[ "$LINE_EXISTS" == true ]]; then
          sed -i -E "s/^\s*#?\s*${PARAM}\s+.*/${PARAM} ${VALUE}/g" "$CONFIG_FILE"
          echo -e "${GREEN}‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä '${PARAM}' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–∑–∞–º–µ–Ω–∞/—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ).${NC}"
      else
          echo "${PARAM} ${VALUE}" >> "$CONFIG_FILE"
          echo -e "${GREEN}‚úÖ –ü–∞—Ä–∞–º–µ—Ç—Ä '${PARAM}' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ).${NC}"
      fi
  fi
}

echo -e "üîß –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –≤ $SSHD_CONFIG..."
update_sshd_config "Port" "$SSH_PORT" "$SSHD_CONFIG"
update_sshd_config "PubkeyAuthentication" "yes" "$SSHD_CONFIG"
update_sshd_config "PasswordAuthentication" "no" "$SSHD_CONFIG"
update_sshd_config "ChallengeResponseAuthentication" "no" "$SSHD_CONFIG"
update_sshd_config "UsePAM" "no" "$SSHD_CONFIG"
update_sshd_config "PermitEmptyPasswords" "no" "$SSHD_CONFIG"
update_sshd_config "PermitRootLogin" "prohibit-password" "$SSHD_CONFIG"
echo ""

# === –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞ UFW ===
echo -e "${CYAN}--- –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–µ—Ä–≤–æ–ª–∞ UFW ---${NC}"
FIREWALL_STATUS="–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–ø—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º)"

if [[ "$SETUP_UFW" == "1" ]]; then
  echo -e "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è UFW..."
  if ! command -v ufw >/dev/null 2>&1; then
    echo -e "${YELLOW} –ö–æ–º–∞–Ω–¥–∞ 'ufw' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–ø—ã—Ç–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–∞–∫–µ—Ç–∞ 'ufw'...${NC}"
    apt update > /dev/null && apt install -y ufw
    if ! command -v ufw >/dev/null 2>&1; then
       echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å UFW. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç —à–∞–≥ –∏–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä—É—á–Ω—É—é ('apt install ufw').${NC}"
       FIREWALL_STATUS="–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ UFW)"
       SETUP_UFW="2"
    else
       echo -e "${GREEN}‚úÖ UFW —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.${NC}"
    fi
  else
      echo -e "${GREEN}‚úÖ UFW –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.${NC}"
  fi

  if [[ "$SETUP_UFW" == "1" ]]; then
    echo -e "üîß –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –ø–æ—Ä—Ç ${SSH_PORT}/tcp..."
    ufw allow "${SSH_PORT}/tcp" comment "Allow SSH on custom port set by script"
    if [[ "$SSH_PORT" -ne 22 ]]; then
      echo -e "üîß –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞ 22/tcp (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)..."
      ufw delete allow 22/tcp > /dev/null 2>&1
      ufw delete allow ssh > /dev/null 2>&1
      echo -e "${CYAN}‚ÑπÔ∏è –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –ø–æ—Ä—Ç–∞ 22/tcp —É–¥–∞–ª–µ–Ω–æ (–µ—Å–ª–∏ –±—ã–ª–æ).${NC}"
    else
      echo -e "${CYAN}‚ÑπÔ∏è –ù–æ–≤—ã–π –ø–æ—Ä—Ç SSH —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º (22). –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –ø–æ—Ä—Ç–∞ 22 –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è.${NC}"
    fi

    UFW_CURRENT_STATUS=$(ufw status | head -n 1)
    if [[ "$UFW_CURRENT_STATUS" == "Status: active" ]]; then
        echo -e "üîß UFW —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª..."
        ufw reload
        if [[ $? -eq 0 ]]; then
            echo -e "${GREEN}‚úÖ –ü—Ä–∞–≤–∏–ª–∞ UFW –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω—ã.${NC}"
            FIREWALL_STATUS="–∞–∫—Ç–∏–≤–µ–Ω, –ø—Ä–∞–≤–∏–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω—ã (–ø–æ—Ä—Ç ${SSH_PORT}/tcp —Ä–∞–∑—Ä–µ—à–µ–Ω)"
        else
            echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ UFW.${NC}"
            FIREWALL_STATUS="–æ—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∞–≤–∏–ª"
        fi
    elif [[ "$UFW_CURRENT_STATUS" == "Status: inactive" ]]; then
        echo -e "üîß UFW –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –í–∫–ª—é—á–µ–Ω–∏–µ UFW..."
        yes | ufw enable
        if ufw status | grep -qw active; then
            echo -e "${GREEN}‚úÖ UFW —É—Å–ø–µ—à–Ω–æ –≤–∫–ª—é—á–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω.${NC}"
            FIREWALL_STATUS="–∞–∫—Ç–∏–≤–µ–Ω (–ø–æ—Ä—Ç ${SSH_PORT}/tcp —Ä–∞–∑—Ä–µ—à–µ–Ω)"
        else
            echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å UFW.${NC}"
            FIREWALL_STATUS="–æ—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏"
        fi
    else
         echo -e "${RED}‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å UFW. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä—É—á–Ω—É—é ('ufw status').${NC}"
         FIREWALL_STATUS="–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å"
    fi
  fi
fi

echo ""
# === –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã SSH ===
echo -e "${CYAN}--- –®–∞–≥ 4: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã SSH ---${NC}"
echo -e "üîß –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–ª—É–∂–±—ã ssh –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
systemctl daemon-reload
systemctl restart ssh.socket

if systemctl is-active --quiet ssh.socket; then
    echo -e "${GREEN}‚úÖ –°–ª—É–∂–±–∞ SSH (ssh.socket) —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞ –∏ –∞–∫—Ç–∏–≤–Ω–∞.${NC}"
else
    echo -e "${RED}‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª—É–∂–±—É SSH!${NC}"
    echo -e "${RED}   –í–æ–∑–º–æ–∂–Ω–æ, –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ${SSHD_CONFIG} –µ—Å—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞.${NC}"
    echo -e "${YELLOW}   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—Ä—É—á–Ω—É—é: ${CYAN}sshd -t${NC}"
    echo -e "${YELLOW}   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–ª—É–∂–±—ã: ${CYAN}journalctl -u ssh.socket -e${NC}"
    echo -e "${YELLOW}   –í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ –±—ç–∫–∞–ø–∞: ${GREEN}${SSHD_CONFIG_BACKUP}${NC}"
    echo -e "${YELLOW}   –ö–æ–º–∞–Ω–¥–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${CYAN}cp ${SSHD_CONFIG_BACKUP} ${SSHD_CONFIG} && systemctl restart ssh.socket${NC}"
fi

echo ""
# === –§–∏–Ω–∞–ª: –í—ã–≤–æ–¥ –æ—Ç—á–µ—Ç–∞ ===
echo -e "${CYAN}=======================================================${NC}"
echo -e "${GREEN}‚úÖ –ù–ê–°–¢–†–û–ô–ö–ê SSH –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!${NC}"
echo -e "${CYAN}=======================================================${NC}"
echo ""
echo -e "${CYAN}üìä –°–≤–æ–¥–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:${NC}"
echo -e "  ${CYAN}üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–ª—è SSH-–∫–ª—é—á–∞: ${GREEN}${TARGET_USER} (${TARGET_USER_HOME})${NC}"
echo -e "  ${CYAN}üìÇ –§–∞–π–ª —Å –∫–ª—é—á–∞–º–∏: ${GREEN}${AUTHORIZED_KEYS}${NC}"
echo -e "  ${CYAN}üîê –ü–æ—Ä—Ç SSH: ${GREEN}${SSH_PORT}${NC}"
echo -e "  ${CYAN}üîë –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ –ø–∞—Ä–æ–ª—é: ${RED}–û–¢–ö–õ–Æ–ß–ï–ù–ê${NC}"
echo -e "  ${CYAN}üß± –°—Ç–∞—Ç—É—Å —Ñ–∞–µ—Ä–≤–æ–ª–∞ (UFW): ${GREEN}${FIREWALL_STATUS}${NC}"
echo -e "  ${CYAN}üìÑ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –∫–æ–Ω—Ñ–∏–≥. SSH: ${GREEN}${SSHD_CONFIG_BACKUP}${NC}"
echo ""
echo -e "${CYAN}=======================================================${NC}"
echo -e "${RED}‚ö†Ô∏è –í–ê–ñ–ù–û! –ü–†–û–í–ï–†–¨–¢–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ü–ï–†–ï–î –í–´–•–û–î–û–ú!${NC}"
echo -e "${CYAN}=======================================================${NC}"
echo -e "${YELLOW}–ü—Ä–µ–∂–¥–µ —á–µ–º –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é –∫–æ–Ω—Å–æ–ª—å, –æ—Ç–∫—Ä–æ–π—Ç–µ –ù–û–í–£–Æ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:${NC}"
echo -e "${CYAN}   ssh ${TARGET_USER}@<IP_–∞–¥—Ä–µ—Å_–∏–ª–∏_–∏–º—è_—Å–µ—Ä–≤–µ—Ä–∞> -p ${SSH_PORT}${NC}"
echo ""
echo -e "${YELLOW}–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à SSH-–∫–ª—é—á, –∏ —á—Ç–æ –≤—Ö–æ–¥ –ø–æ –ø–∞—Ä–æ–ª—é –ù–ï –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è.${NC}"
echo -e "${YELLOW}–ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–ª–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—ç–∫–∞–ø.${NC}"
echo -e "${CYAN}=======================================================${NC}"

en

